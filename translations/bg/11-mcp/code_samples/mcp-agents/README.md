<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "5cc6836626047aa055e8960c8484a7d0",
  "translation_date": "2025-08-21T14:56:00+00:00",
  "source_file": "11-mcp/code_samples/mcp-agents/README.md",
  "language_code": "bg"
}
-->
# Създаване на системи за комуникация между агенти с MCP

> Накратко - Можете ли да изградите комуникация между агенти с MCP? Да!

MCP се е развил значително отвъд първоначалната си цел да "осигурява контекст за LLMs". С последните подобрения, включително [възобновяеми потоци](https://modelcontextprotocol.io/docs/concepts/transports#resumability-and-redelivery), [елицитация](https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation), [семплиране](https://modelcontextprotocol.io/specification/2025-06-18/client/sampling) и известия ([прогрес](https://modelcontextprotocol.io/specification/2025-06-18/basic/utilities/progress) и [ресурси](https://modelcontextprotocol.io/specification/2025-06-18/schema#resourceupdatednotification)), MCP вече предоставя стабилна основа за изграждане на сложни системи за комуникация между агенти.

## Заблудата за агент/инструмент

С увеличаването на броя разработчици, които изследват инструменти с агентно поведение (работят за дълги периоди, може да изискват допълнителен вход по време на изпълнение и т.н.), често срещана заблуда е, че MCP не е подходящ, главно защото ранните примери за неговия инструментален примитив се фокусираха върху прости модели на заявка-отговор.

Това възприятие е остаряло. Спецификацията на MCP беше значително подобрена през последните месеци с възможности, които запълват празнината за изграждане на дългосрочно агентно поведение:

- **Потоци и частични резултати**: Актуализации в реално време по време на изпълнение
- **Възобновяемост**: Клиентите могат да се свържат отново и да продължат след прекъсване
- **Устойчивост**: Резултатите оцеляват при рестартиране на сървъра (например чрез връзки към ресурси)
- **Многоходови взаимодействия**: Интерактивен вход по време на изпълнение чрез елицитация и семплиране

Тези функции могат да бъдат комбинирани, за да позволят сложни агентни и мултиагентни приложения, всички внедрени върху MCP протокола.

За справка, ще наричаме агент "инструмент", който е наличен на MCP сървър. Това предполага съществуването на хост приложение, което реализира MCP клиент, установява сесия с MCP сървъра и може да извиква агента.

## Какво прави един MCP инструмент "агентен"?

Преди да преминем към реализацията, нека определим какви инфраструктурни възможности са необходими за поддръжка на дългосрочни агенти.

> Ще дефинираме агент като субект, който може да работи автономно за продължителни периоди, способен да се справя със сложни задачи, които може да изискват множество взаимодействия или корекции въз основа на обратна връзка в реално време.

### 1. Потоци и частични резултати

Традиционните модели на заявка-отговор не работят за дългосрочни задачи. Агенти трябва да предоставят:

- Актуализации за прогреса в реално време
- Междинни резултати

**Поддръжка от MCP**: Известията за актуализация на ресурси позволяват поточно предаване на частични резултати, въпреки че това изисква внимателен дизайн, за да се избегнат конфликти с модела 1:1 заявка/отговор на JSON-RPC.

| Функция                   | Пример за употреба                                                                                                                                                                       | Поддръжка от MCP                                                                          |
| ------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| Актуализации за прогреса  | Потребителят заявява задача за миграция на кодова база. Агентът предава прогреса: "10% - Анализ на зависимости... 25% - Конвертиране на TypeScript файлове... 50% - Актуализиране на импорти..." | ✅ Известия за прогрес                                                                     |
| Частични резултати        | Задача "Генериране на книга" предава частични резултати, напр. 1) Очертание на историята, 2) Списък с глави, 3) Всяка глава, когато е завършена. Хостът може да инспектира, отмени или пренасочи на всеки етап. | ✅ Известията могат да бъдат "разширени", за да включват частични резултати (виж PR 383, 776) |

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Фигура 1:</strong> Тази диаграма илюстрира как MCP агент предава актуализации за прогреса в реално време и частични резултати към хост приложението по време на дългосрочна задача, позволявайки на потребителя да следи изпълнението в реално време.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)

    User->>Host: Start long task
    Host->>Server: Call agent_tool()

    loop Progress Updates
        Server-->>Host: Progress + partial results
        Host-->>User: Stream updates
    end

    Server-->>Host: ✅ Final result
    Host-->>User: Complete
```

### 2. Възобновяемост

Агентите трябва да се справят с прекъсвания на мрежата безпроблемно:

- Възстановяване след прекъсване на клиента
- Продължаване от мястото, където са спрели (повторно предаване на съобщения)

**Поддръжка от MCP**: MCP StreamableHTTP транспортът днес поддържа възобновяване на сесии и повторно предаване на съобщения със session IDs и last event IDs. Важно е сървърът да реализира EventStore, който позволява повторно възпроизвеждане на събития при повторно свързване на клиента.  
Има предложение от общността (PR #975), което изследва транспортно-агностични възобновяеми потоци.

| Функция       | Пример за употреба                                                                                                                                                   | Поддръжка от MCP                                                                |
| ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- |
| Възобновяемост | Клиентът се прекъсва по време на дългосрочна задача. При повторно свързване сесията се възобновява с възпроизвеждане на пропуснатите събития, продължавайки безпроблемно. | ✅ StreamableHTTP транспорт със session IDs, възпроизвеждане на събития и EventStore |

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Фигура 2:</strong> Тази диаграма показва как StreamableHTTP транспортът и EventStore на MCP позволяват безпроблемно възобновяване на сесии: ако клиентът се прекъсне, той може да се свърже отново и да възпроизведе пропуснатите събития, продължавайки задачата без загуба на прогрес.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)
    participant Store as Event Store

    User->>Host: Start task
    Host->>Server: Call tool [session: abc123]
    Server->>Store: Save events

    Note over Host,Server: 💥 Connection lost

    Host->>Server: Reconnect [session: abc123]
    Store-->>Server: Replay events
    Server-->>Host: Catch up + continue
    Host-->>User: ✅ Complete
```

### 3. Устойчивост

Дългосрочните агенти се нуждаят от постоянна състояние:

- Резултатите оцеляват при рестартиране на сървъра
- Статусът може да бъде извлечен извън сесията
- Проследяване на прогреса между сесиите

**Поддръжка от MCP**: MCP вече поддържа тип връзка към ресурс като резултат от извикване на инструмент. Днес възможен модел е да се проектира инструмент, който създава ресурс и веднага връща връзка към ресурса. Инструментът може да продължи да обработва задачата във фонов режим и да актуализира ресурса. Клиентът може да избере да проверява състоянието на този ресурс, за да получи частични или пълни резултати (въз основа на предоставените от сървъра актуализации на ресурса) или да се абонира за ресурса за известия за актуализации.

Едно ограничение тук е, че проверката на ресурси или абонирането за актуализации може да консумира ресурси с последствия при мащабиране. Има отворено предложение от общността (включително #992), което изследва възможността за включване на уебхукове или тригери, които сървърът може да извика, за да уведоми клиента/хост приложението за актуализации.

| Функция     | Пример за употреба                                                                                                                                        | Поддръжка от MCP                                                        |
| ----------- | ------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------- |
| Устойчивост | Сървърът се срива по време на задача за миграция на данни. Резултатите и прогресът оцеляват при рестартиране, клиентът може да провери състоянието и да продължи от постоянния ресурс. | ✅ Връзки към ресурси с постоянна памет и известия за състоянието |

Днес често срещан модел е да се проектира инструмент, който създава ресурс и веднага връща връзка към ресурса. Инструментът може във фонов режим да обработва задачата, да издава известия за ресурса, които служат като актуализации за прогреса или включват частични резултати, и да актуализира съдържанието в ресурса според нуждите.

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Фигура 3:</strong> Тази диаграма демонстрира как MCP агентите използват постоянни ресурси и известия за състоянието, за да гарантират, че дългосрочните задачи оцеляват при рестартиране на сървъра, позволявайки на клиентите да проверяват прогреса и да извличат резултати дори след сривове.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)
    participant DB as Persistent Storage

    User->>Host: Start task
    Host->>Server: Call tool
    Server->>DB: Create resource + updates
    Server-->>Host: 🔗 Resource link

    Note over Server: 💥 Server restart

    User->>Host: Check status
    Host->>Server: Get resource
    Server->>DB: Load state
    Server-->>Host: Current progress
    Server->>DB: Complete + notify
    Host-->>User: ✅ Complete
```

### 4. Многоходови взаимодействия

Агентите често се нуждаят от допълнителен вход по време на изпълнение:

- Уточнение или одобрение от човек
- Помощ от ИИ за сложни решения
- Динамично настройване на параметри

**Поддръжка от MCP**: Напълно поддържано чрез семплиране (за вход от ИИ) и елицитация (за вход от човек).

| Функция                 | Пример за употреба                                                                                                                                     | Поддръжка от MCP                                           |
| ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| Многоходови взаимодействия | Агенция за резервации на пътувания иска потвърждение на цената от потребителя, след което моли ИИ да обобщи данните за пътуването преди завършване на транзакцията. | ✅ Елицитация за вход от човек, семплиране за вход от ИИ |

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Фигура 4:</strong> Тази диаграма изобразява как MCP агентите могат интерактивно да изискват вход от човек или да поискат помощ от ИИ по време на изпълнение, поддържайки сложни, многоходови работни потоци като потвърждения и динамично вземане на решения.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)

    User->>Host: Book flight
    Host->>Server: Call travel_agent

    Server->>Host: Elicitation: "Confirm $500?"
    Note over Host: Elicitation callback (if available)
    Host->>User: 💰 Confirm price?
    User->>Host: "Yes"
    Host->>Server: Confirmed

    Server->>Host: Sampling: "Summarize data"
    Note over Host: AI callback (if available)
    Host->>Server: Report summary

    Server->>Host: ✅ Flight booked
```

## Реализиране на дългосрочни агенти върху MCP - Преглед на кода

Като част от тази статия предоставяме [репозитория с код](https://github.com/victordibia/ai-tutorials/tree/main/MCP%20Agents), който съдържа пълна реализация на дългосрочни агенти, използвайки MCP Python SDK със StreamableHTTP транспорт за възобновяване на сесии и повторно предаване на съобщения. Реализацията демонстрира как възможностите на MCP могат да бъдат комбинирани, за да позволят сложни поведения, подобни на агенти.

Специално реализираме сървър с два основни инструмента за агенти:

- **Агент за пътувания** - Симулира услуга за резервации на пътувания с потвърждение на цената чрез елицитация
- **Агент за изследвания** - Извършва изследователски задачи с помощ от ИИ за обобщения чрез семплиране

И двата агента демонстрират актуализации за прогреса в реално време, интерактивни потвърждения и пълни възможности за възобновяване на сесии.

**Отказ от отговорност**:  
Този документ е преведен с помощта на AI услуга за превод [Co-op Translator](https://github.com/Azure/co-op-translator). Въпреки че се стремим към точност, моля, имайте предвид, че автоматизираните преводи може да съдържат грешки или неточности. Оригиналният документ на неговия изходен език трябва да се счита за авторитетен източник. За критична информация се препоръчва професионален човешки превод. Ние не носим отговорност за каквито и да е недоразумения или погрешни интерпретации, произтичащи от използването на този превод.